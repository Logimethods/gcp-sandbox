'use strict';

const mysql = require('promise-mysql');
var ejs = require('ejs');
const express = require('express');


function createPool() {
    var pool;
    var options = {
        user: 'dbuser',
        password: 'dbuser',
        database: 'timesheets',
        socketPath: `/cloudsql/gcp-sandbox-266014:us-east4:mysql-s-sandbox-us-east4-master`,
		// host:	'35.245.9.72',
		// port:	'3306',
        connectionLimit: 5,
        connectTimeout: 10000, // 10 seconds
        acquireTimeout: 10000, // 10 seconds
        waitForConnections: true, // Default: true
        queueLimit: 0, // Default: 0
    };
    return new Promise((resolve, reject) => {
        try{
            pool = mysql.createPool(options);
            resolve(pool);
        } catch (err){
            console.log(err)
            reject(err);
        }
    });
}



/**
 * Responds to any HTTP request.
 *
 * @param {!express:Request} req HTTP request context.
 * @param {!express:Response} res HTTP response context.
 */
// 
exports.showStatus = async (req, res) => {
//  trypool();
//  function trypool(){
    // console.log('resres');
    // console.log(res.json());
    // var app = express();
    // app.set('view engine', 'ejs');
    var orgs;// = JSON.parse('[{"org":"Logi-Labs"},{"org":"Logimethods"}]');
    var table_rows;// = JSON.parse('[{"id":"1-4TfCKYRltqd28WNRoe-V6rXJOEX5AiW5B8Y5kn95cE","name":"Timesheet Khevind Jugessur","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"17eY_87EdHhf3WfBPDaY7K6wkj5hMYnE4zeHvJjvH_NY","name":"Timesheet Selsabil Dbouba","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"19xVpGfxcGJhu7KhrFewz8YUGD2W7VrCOyN3QTcx2oOY","name":"Timesheet Ismeet Kaur","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1awsmQCsepFgaWIpVhGiEKu1VmmAsbd4lev3K-o1jyhM","name":"Timesheet Devon Ochman","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1BxN1halDCowEcWW64eop-oKgGxavsgT0Ve0ZlkwFyrc","name":"Timesheet Christopher Di Betta","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1bY1b5MJJZZjpgcwcxM-QD1DDi__X8CE1cHR3cu_C1mg","name":"Timesheet Remi Caron St-Pierre","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1eKxF87tjmOU3OyTlg7UKnq3zCSPKVWWXAemnTEagCHo","name":"Timesheet Vineet Sharma","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1Fn-OGfO057Tn2PwSD9IrFFpR3N3vrOBM7QaJnfx6toQ","name":"Timesheet Lutchumaya Veeranna","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1jldyI2RW4fWC5dto84qWc1oVbCgtE5eynR-NLJ0tQKg","name":"Timesheet Benjamin Carrier","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1lI-stsBTuMdhIZyq0x6h9kzZ0WchvSuTGK0BFWU6BKg","name":"Timesheet Jinal Doshi","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1NEbJurVp8S1ZUmlTEK-OGGK3lrHY_z3vXFnphyBLbng","name":"Timesheet Daniel Makardich","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1NGi-RwtPIIBi5awoOycPbIVawMbZLlV3w6GBtK6bktY","name":"Timesheet Michael Li Fraine","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1pFwlk5GUZCFH9yMcPgWZkkYXjuJ9Nim-b4K0YpuNxM0","name":"Timesheet Shubham Kalsi","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1SNw0EbNSccKxN0LcDLW2ODIdkhN2PBj0lrsPvut475M","name":"Timesheet Shashank Puli","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1U__rVmTtm-q8KXlGMH7kd9PoTfR8OVGUELsGJkLpYAQ","name":"Timesheet Bob Seney","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1wurtKWqisChYIxfrT41I8sjp5kGfGlRWNABFcltpIVo","name":"Timesheet David Belliveau","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1zH9YkYGSHlPHitoBFwNkWMJyV3pnXpy31Z3MUblT4wA","name":"Timesheet Leotard Niyonkuru","org":"Logi-Labs","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"10--0cqN2-kMrZWlWlt6mnylGA2hpeoodsUamDYrzuhU","name":"Timesheet Laura Braia","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"118MJHOM_kNvKeFL_meScGZmRLy_0drOG3uYtHqgw-1w","name":"Timesheet Sridhar Vasudevan","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"13EqclL0iAnTarAGqPQlelh_y4cxg6IeL44gJN0ERoog","name":"Timesheet Josee Gibeault","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"15e0ppmBIw9pYc7jfVpENT_45MI-26eyIZ-ia7QFTCfE","name":"Timesheet Antoine Charles","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"16GgZ0Kk54YMT33ndI3Us6CE3Vm9tr1TGycxe4Um4jcU","name":"Timesheet Jinal Doshi","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"16Srf3GY2xh68UgrOosJq6JT31kir4ZNbNfXotJXEeA0","name":"Timesheet Leotard Niyonkuru","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"176bYsOqMx1Z39Fs_8BtH5CaH95JZLzjUpyc6knYVIh8","name":"Timesheet Benjamin Carrier","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"19Hf5lfz6bjoPkfpSjJDgx_CLhB91NWcB0hi3qPMQ6zo","name":"Timesheet William Campoli","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1aqduPG8BOtD0vMYP01qtxkmQaOwkOSCMLqv9hLobWp8","name":"Timesheet Vineet sharma","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1BCbQzgbH3npvwxOyovhAB-LaJeo3sLPMnIV4IvklIlk","name":"Timesheet Chris Krikorian","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1bY_siFRnY5rxLR5TaWPOvHGFO5ZJgjdiEcgH8iswxwI","name":"Timesheet Ishtiyak Siddiqui","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1CC4GHggNE1uxAetG_OhjBdKM1reaIqRPX0u-TOGmOlY","name":"Timesheet Christopher Di Betta","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1CR0xEg-eZQ4e-IeokyZJhYNqeU1h40kcRtgTGZOgB74","name":"Timesheet James Gerber","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":0},{"id":"1cZ3UTgezk_XqOrLk0iKFKpnSYFsG0-YGFJfgST3fke0","name":"Timesheet Ashley Stendel","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1dMCdSGTNObMZ0iWZ8aMND6pdmjD0yCexc5dJk_KL3Bo","name":"Timesheet David Belliveau","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1Eb1HioBf2-7r7ys2xFSd62ayMUVmRNwnwd4KQg3-7yc","name":"Timesheet Pascal Gauthier","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1efmh4qqaPcsGSsCJejfdhtFRNGO4Owaay1NvltYkJXU","name":"Timesheet Remi Caron St-Pierre","org":"Logimethods","month_check_date":null,"week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1GCyV4VIJBtXoUZbQphj8rHBks5GOumwCmHaqnLF6LiQ","name":"Timesheet Noah Ritcey","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1HdEg5b43-DA6zEjwjc7A9vCXOrxYh0gpC8kB0x1vX_U","name":"Timesheet Faiaz Mohammad","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1iSeRR11TxN-gTiKXvPoghQ5LCmhjMGgvhvhIjiWAQYI","name":"Timesheet Gagandeep Singh","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1jibPRFDRHJD17kF0CTgjQGhdQL1vJvrttmYfnWdZGVA","name":"Timesheet Shilpa Prathikantam","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1KIDRRCJ_vlE1ryEQ22er8QNwxz-t9VV711nsQVABLZY","name":"Timesheet Andy Luong","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1kvQqjX30ZOak66-qbhXL2Wfh7nSIiffj55kkH0eqQk8","name":"Timesheet Venkata Nekkanti","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1k_hVUaCQ_wcK2vGI161x5DmjXz2R0gHQWf-AKxAXB_0","name":"Timesheet Alejandro Edo Arquero","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1LuyrYJK6k7JbKjW-hPgFcdPSfuAxMLkV7QRirEgz4D8","name":"Timesheet Igor Fomenko","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1LzCmJ_2JZO1U0LSBj6727PH7S0RwelUHU7SMQrkn-dQ","name":"Timesheet Daniel Makardich","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1mczpu1G8FvWqSnnhK6qFxUWyCbBUvIAvOPAPGTuHdJE","name":"Timesheet Aldwin Panganiban","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1MfQRgHe0A0_KBA4OZzJt9aOclWwyqeq3Xyndb6Ax6iE","name":"Timesheet Sukhdev Singh","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1mkUypzPd-VQunCvGcua0EhPIX_w229Ao2zPy2e3qVWA","name":"Timesheet Olivier Winter","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1MSxbol96yMziax6ResYbax9WeB94hoKt97NgiNcj_-w","name":"Timesheet Perrine Assemat","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1nlpGZnqq_RIzdH1F02JGfp8u0PNrAiGKP0HePS9fjLI","name":"Timesheet Ayoub Fliou","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1NrhXqFfWlX2tDb0KBDNnrMJaxjEFqVRn0cn4P7PecFY","name":"Timesheet Shubham Kalsi","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1NYQN6tlagosG5iB7wCZBN2xaU-diHuURKoAdvhJLH6I","name":"Timesheet Zeeshan Hanif_2019","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1oNbqaCg63iLqDzEcOUBL0tLtGqafWtjuqhSmcnvvlmI","name":"Timesheet Jibril H","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1QHwOpT0AZ7ZK58k04qm-S0kXYllo93eTuG3ynoqO52U","name":"Timesheet Ismeet Kaur","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1rDc2mhIZuBxLzmAREOvlBJdFKgAnF3bty5J-8l1LEhg","name":"Timesheet Example Sheet","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1s2fnOfUGwFgOI9yh1KI9fFMtEtTTnasRuWoUr8zY9Us","name":"Timesheet Selsabil Dbouba","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1t6W7gSIf3wiDDbT6f4XZGFhilpvmHZfvQ-D_ArG5gio","name":"Timesheet Lutchumaya Veeranna","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1u-mhV0NBMrd2SpZgHALYi1Nh8YdWAagMO44N2C2m-KI","name":"Timesheet Khevind Jugessur","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1u4dKS8QDqgW9bglSr4cfGL5mr134xLMQu1ogGOcWNgY","name":"Timesheet John Rivera","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1UeyZlmVJdL9KU0ssOYPV3Jmaaoq-wMcHUiLPJOr1TrE","name":"Timesheet Michael Li Fraine","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1uVkgjLT7T-VQczyWh7xiqLPlJFhyXQ7tLZMHlXrkmp8","name":"Timesheet Shashank Puli","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1vQluWnnpD54EXwzPQj8rT5TpIR4oqyOV7JKXCk8_11o","name":"Timesheet Devon Ochman","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1VRdnCCP-cPPRbo86bkkeH1BggS8kSsm_5zYz3Lqwkgw","name":"Timesheet Olivier Gosselin","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1xeRK0ci97RiDtUq5QwIO6FfgCRmjz227dSLqtTeLlIY","name":"Timesheet Bob Seney","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1Zk1KRmSXuU5LNH5s9_8dYgbS1dxVm6RXJot6MnGPc2M","name":"Timesheet Venu Vaka","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1},{"id":"1Zo-xJ8FEhvXOPGSpyBmnmlWjJL5fX0WmE8lrLf1-cOM","name":"Timesheet Laurent Magnin","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":0,"week_status":0},{"id":"1zuQmI5vVpU4PjCsp3D_HNccRjaRFeak2hgT5SoFlmdU","name":"Timesheet Waldes Machado","org":"Logimethods","month_check_date":"2020-01-01T00:00:00.000Z","week_check_date":"2020-01-01T00:00:00.000Z","month_status":1,"week_status":1}]');
    // console.log(orgs);
    // console.log(table_rows.length);
    // var html = ejs.renderFile('views/query.ejs', { table_rows: table_rows, orgs: orgs });
    // console.log(html);
    var initCreatePoolPromise = createPool();
    initCreatePoolPromise.then((pool) => {
        var stmt = 'SELECT DISTINCT org from status';
        pool.query(stmt, function (err, result) {
            if(err) throw err;
            console.log(JSON.stringify(result));
            orgs = JSON.parse(JSON.stringify(result));
            // console.log(orgs);
            stmt = 'SELECT id, name, org, CONVERT(month_check_date, CHAR) AS month_check_date, CONVERT(week_check_date, CHAR) AS week_check_date, month_status, week_status FROM status group by org,week_status,month_status,timesheets.status.id';
            pool.query(stmt, function (err1, result1) {
                if(err1) throw err1;
                console.log(JSON.stringify(result1));
                table_rows = JSON.parse(JSON.stringify(result1));
                // console.log(table_rows.length);
                ejs.renderFile('views/query.ejs', { table_rows: table_rows, orgs: orgs }, (err2, str) => {
                    if(err2) throw err2
                    res.send(str);
                });
            });
        });
    })
}